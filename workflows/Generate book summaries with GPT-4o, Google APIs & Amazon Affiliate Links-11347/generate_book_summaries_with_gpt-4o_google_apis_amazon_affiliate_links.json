{"name":"AI Book Advisor: Reviews & Recommendations (Final Layout)","nodes":[{"id":"sticky-main","name":"Sticky Note Main","type":"n8n-nodes-base.stickyNote","position":[-380,240],"parameters":{"color":4,"width":380,"height":400,"content":"# AI Book Advisor with Affiliate Support\n\n## How it works\nThis workflow acts as an automated book curator.\n1. **Trigger:** Starts when a user submits a book title via the form.\n2. **Research:** Fetches metadata from Google Books and search results for reviews.\n3. **Analysis:** GPT-4o analyzes the gathered info to write a summary and suggest related books.\n4. **Delivery:** Sends a formatted HTML email containing Amazon affiliate links and logs the entry to Google Sheets.\n\n## Setup steps\n1. **Google Sheets:** Create a sheet with headers: `date`, `book_title`, `author`, `ai_comment`, `user_email`.\n2. **Credentials:** Configure OpenAI, Google Custom Search, and Gmail.\n3. **Config:** Open the **\"1. Input & Config\"** section to enter your API Keys and Amazon Affiliate Tag."},"typeVersion":1},{"id":"sticky-input","name":"Sticky Note Input","type":"n8n-nodes-base.stickyNote","position":[40,240],"parameters":{"color":7,"width":340,"height":260,"content":"## 1. Input & Config\nAccepts user requests via Form and defines API keys/tags."},"typeVersion":1},{"id":"sticky-enrichment","name":"Sticky Note Enrichment","type":"n8n-nodes-base.stickyNote","position":[420,240],"parameters":{"color":7,"width":960,"height":400,"content":"## 2. Data Enrichment\nRetrieves book details (Google Books) and search results (Custom Search) for context."},"typeVersion":1},{"id":"sticky-ai","name":"Sticky Note AI","type":"n8n-nodes-base.stickyNote","position":[1420,240],"parameters":{"color":7,"width":540,"height":400,"content":"## 3. AI Analysis\nGPT-4o summarizes reviews and recommends related books in JSON format."},"typeVersion":1},{"id":"sticky-delivery","name":"Sticky Note Delivery","type":"n8n-nodes-base.stickyNote","position":[2000,240],"parameters":{"color":7,"width":680,"height":400,"content":"## 4. Delivery & Log\nBuilds an HTML email with affiliate links, sends it, and saves data to Sheets."},"typeVersion":1},{"id":"form-trigger","name":"Book Input Form","type":"n8n-nodes-base.formTrigger","position":[80,340],"webhookId":"0a6d4565-ecaf-4e65-8803-1c49cb3b12b6","parameters":{"options":{"buttonLabel":"Start Research"},"formTitle":"ğŸ“š Book Reading Advisor","formFields":{"values":[{"fieldLabel":"æ›¸å (Book Title)","requiredField":true},{"fieldLabel":"è‘—è€…å (Author Name - Optional)"},{"fieldType":"email","fieldLabel":"ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆ (Email Address)","requiredField":true}]},"formDescription":"Enter a book title. AI will research it and send you a summary with recommendations."},"typeVersion":2.3},{"id":"config","name":"Workflow Configuration","type":"n8n-nodes-base.set","position":[240,340],"parameters":{"options":{},"assignments":{"assignments":[{"id":"id-1","name":"googleBooksApiUrl","type":"string","value":"https://www.googleapis.com/books/v1/volumes"},{"id":"id-2","name":"googleCustomSearchApiUrl","type":"string","value":"https://www.googleapis.com/customsearch/v1"},{"id":"id-3","name":"googleCustomSearchApiKey","type":"string","value":"<__PLACEHOLDER_VALUE__Google_Custom_Search_API_Key__>"},{"id":"id-4","name":"googleCustomSearchEngineId","type":"string","value":"<__PLACEHOLDER_VALUE__Search_Engine_ID__>"},{"id":"id-5","name":"userEmail","type":"string","value":"={{ $json['ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆ (Email Address)'] }}"},{"id":"id-6","name":"sheetId","type":"string","value":"<__PLACEHOLDER_VALUE__Google_Sheet_ID__>"},{"id":"id-7","name":"amazonAffiliateTag","type":"string","value":"<__PLACEHOLDER_VALUE__Amazon_Associate_Tag__>"}]},"includeOtherFields":true},"typeVersion":3.4},{"id":"search-books","name":"Search Book on Google Books API","type":"n8n-nodes-base.httpRequest","position":[480,340],"parameters":{"url":"={{ $('Workflow Configuration').first().json.googleBooksApiUrl }}?q=intitle:{{ encodeURIComponent($json.bookTitle) }}{{ $json.authorName ? '+inauthor:' + encodeURIComponent($json.authorName) : '' }}&maxResults=1&langRestrict=ja","options":{"response":{"response":{"responseFormat":"json"}}}},"typeVersion":4.3},{"id":"check-found","name":"Check if Book Found","type":"n8n-nodes-base.if","position":[680,340],"parameters":{"options":{},"conditions":{"options":{"leftValue":"","caseSensitive":true,"typeValidation":"loose"},"combinator":"and","conditions":[{"id":"id-1","operator":{"type":"number","operation":"gt"},"leftValue":"={{ $json.totalItems }}","rightValue":"0"}]}},"typeVersion":2.2},{"id":"extract-details","name":"Extract Book Details","type":"n8n-nodes-base.set","position":[900,340],"parameters":{"options":{},"assignments":{"assignments":[{"id":"id-1","name":"bookTitle","type":"string","value":"={{ $json.items[0].volumeInfo.title }}"},{"id":"id-2","name":"bookAuthors","type":"string","value":"={{ $json.items[0].volumeInfo.authors ? $json.items[0].volumeInfo.authors.join(', ') : 'Unknown' }}"},{"id":"id-3","name":"bookDescription","type":"string","value":"={{ $json.items[0].volumeInfo.description || 'No description available' }}"},{"id":"id-4","name":"bookIsbn","type":"string","value":"={{ $json.items[0].volumeInfo.industryIdentifiers ? $json.items[0].volumeInfo.industryIdentifiers.find(id => id.type === 'ISBN_13')?.identifier || $json.items[0].volumeInfo.industryIdentifiers[0]?.identifier : 'N/A' }}"},{"id":"id-5","name":"bookCoverImage","type":"string","value":"={{ $json.items[0].volumeInfo.imageLinks?.thumbnail || '' }}"},{"id":"id-6","name":"bookPublisher","type":"string","value":"={{ $json.items[0].volumeInfo.publisher || 'Unknown' }}"},{"id":"id-7","name":"bookPublishedDate","type":"string","value":"={{ $json.items[0].volumeInfo.publishedDate || 'Unknown' }}"}]},"includeOtherFields":true},"typeVersion":3.4},{"id":"search-reviews","name":"Search Book Reviews on Google","type":"n8n-nodes-base.httpRequest","position":[1100,340],"parameters":{"url":"={{ $('Workflow Configuration').first().json.googleCustomSearchApiUrl }}?key={{ $('Workflow Configuration').first().json.googleCustomSearchApiKey }}&cx={{ $('Workflow Configuration').first().json.googleCustomSearchEngineId }}&q={{ encodeURIComponent($json.bookTitle + ' æ›¸è©• æ„Ÿæƒ³') }}&num=5","options":{"response":{"response":{"responseFormat":"json"}}}},"typeVersion":4.3},{"id":"prepare-input","name":"Prepare AI Input","type":"n8n-nodes-base.set","position":[1300,340],"parameters":{"options":{},"assignments":{"assignments":[{"id":"id-1","name":"reviewSnippets","type":"string","value":"={{ $json.items ? $json.items.map(item => item.snippet).join('\\n\\n') : 'No reviews found' }}"}]},"includeOtherFields":true},"typeVersion":3.4},{"id":"ai-agent","name":"Book Curator AI Agent","type":"@n8n/n8n-nodes-langchain.agent","position":[1480,340],"parameters":{"text":"=æ›¸ç±æƒ…å ±:\næ›¸å: {{ $json.bookTitle }}\nè‘—è€…: {{ $json.bookAuthors }}\n\nã‚ã‚‰ã™ã˜:\n{{ $json.bookDescription }}\n\nWebä¸Šã®ãƒ¬ãƒ“ãƒ¥ãƒ¼:\n{{ $json.reviewSnippets }}","options":{"systemMessage":"ã‚ãªãŸã¯ãƒ—ãƒ­ã®ãƒ–ãƒƒã‚¯ãƒ»ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚èª­è€…ã®é¸æ›¸ã‚’æ”¯æ´ã—ã€èª­æ›¸ä½“é¨“ã‚’æ·±ã‚ã‚‹ãŸã‚ã®æ¨è–¦ã‚’è¡Œã„ã¾ã™ã€‚\n\nã‚ãªãŸã®ã‚¿ã‚¹ã‚¯:\n1. æä¾›ã•ã‚ŒãŸæ›¸ç±æƒ…å ±ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ†æã—ã€ã“ã®æœ¬ã®é­…åŠ›ã‚’150æ–‡å­—ä»¥å†…ã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚\n2. ã“ã®æœ¬ã«é–¢å¿ƒãŒã‚ã‚‹äººãŒã€ã•ã‚‰ã«ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã«èª­ã‚€ã¹ãã€Œé–¢é€£æ›¸ç±ã€ã‚’3å†ŠæŒ™ã’ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚"},"promptType":"define","hasOutputParser":true},"typeVersion":3},{"id":"openai-model","name":"OpenAI Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[1480,540],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o"},"options":{}},"credentials":{"openAiApi":{"id":"credential-id","name":"openAiApi Credential"}},"typeVersion":1.2},{"id":"build-html","name":"Build HTML Email","type":"n8n-nodes-base.code","position":[2060,340],"parameters":{"jsCode":"// Build HTML Email with Book Cover, AI Recommendations, and Purchase Links\n\nconst items = $input.all();\nconst results = [];\n\n// Get Affiliate Tag from Config\nconst configItem = $('Workflow Configuration').first();\nconst affiliateTag = configItem ? configItem.json.amazonAffiliateTag : '';\n\nfor (const item of items) {\n  const aiData = item.json;\n  const bookDetails = $('Extract Book Details').first().json;\n  \n  const bookTitle = bookDetails.bookTitle || 'Unknown Title';\n  const bookAuthor = bookDetails.bookAuthors || 'Unknown Author';\n  const bookCover = bookDetails.bookCoverImage || '';\n  const isbn = bookDetails.bookIsbn;\n\n  // Data from AI (Structured)\n  const aiComment = aiData.review_summary || 'No review available.';\n  const relatedBooks = aiData.related_books || [];\n\n  // Generate Main Book Links (with Affiliate Tag Support)\n  let mainAmazonLink = isbn && isbn !== 'N/A' \n    ? `https://www.amazon.co.jp/s?k=${isbn}` \n    : `https://www.amazon.co.jp/s?k=${encodeURIComponent(bookTitle + ' ' + bookAuthor)}`;\n  \n  if (affiliateTag && affiliateTag !== '<__PLACEHOLDER_VALUE__Amazon_Associate_Tag__>') {\n      mainAmazonLink += `&tag=${affiliateTag}`;\n  }\n    \n  const mainRakutenLink = isbn && isbn !== 'N/A'\n    ? `https://books.rakuten.co.jp/search?sitem=${isbn}`\n    : `https://books.rakuten.co.jp/search?sitem=${encodeURIComponent(bookTitle + ' ' + bookAuthor)}`;\n\n  // Helper to generate related book rows\n  let relatedBooksHtml = '';\n  relatedBooks.forEach(book => {\n    let rAmazon = `https://www.amazon.co.jp/s?k=${encodeURIComponent(book.title + ' ' + book.author)}`;\n    if (affiliateTag && affiliateTag !== '<__PLACEHOLDER_VALUE__Amazon_Associate_Tag__>') {\n      rAmazon += `&tag=${affiliateTag}`;\n    }\n\n    relatedBooksHtml += `\n      <div style=\"margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc;\">\n        <p style=\"margin: 0; font-weight: bold;\">ã€${book.title}ã€</p>\n        <p style=\"margin: 0; font-size: 0.9em; color: #666;\">${book.author}</p>\n        <p style=\"margin: 5px 0;\">${book.reason}</p>\n        <a href=\"${rAmazon}\" style=\"font-size: 0.8em; color: #4CAF50; text-decoration: none;\">Amazonã§æ¢ã™ &rarr;</a>\n      </div>\n    `;\n  });\n\n  // Build rich HTML email\n  const htmlContent = `\n<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>èª­æ›¸ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</title>\n  <style>\n    body { font-family: sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .container { background-color: #ffffff; border-radius: 10px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n    .header { text-align: center; border-bottom: 3px solid #4CAF50; padding-bottom: 20px; margin-bottom: 30px; }\n    .book-cover { text-align: center; margin: 20px 0; }\n    .book-cover img { max-width: 150px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n    .section { margin: 25px 0; padding: 15px; background-color: #f4f4f4; border-left: 4px solid #4CAF50; }\n    .button { display: inline-block; padding: 10px 20px; margin: 5px; background-color: #FF9900; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\"><h1>ğŸ“š èª­æ›¸ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h1></div>\n    ${bookCover ? `<div class=\"book-cover\"><img src=\"${bookCover}\"></div>` : ''}\n    <h2>${bookTitle}</h2>\n    <p>è‘—è€…: ${bookAuthor}</p>\n    <div class=\"section\"><h4>ğŸ¤– AIã‚­ãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®è§£èª¬</h4><p>${aiComment}</p></div>\n    <div class=\"section\"><h4>ğŸ”— ãŠã™ã™ã‚é–¢é€£æ›¸ç±</h4>${relatedBooksHtml}</div>\n    <div style=\"text-align: center;\">\n      <a href=\"${mainAmazonLink}\" class=\"button\">Amazonã§è³¼å…¥</a>\n    </div>\n  </div>\n</body>\n</html>\n  `;\n  \n  results.push({\n    json: {\n      htmlEmail: htmlContent,\n      emailSubject: `ğŸ“š æ›¸ç±ãƒ¬ãƒãƒ¼ãƒˆ: ${bookTitle}`\n    }\n  });\n}\n\nreturn results;"},"typeVersion":2},{"id":"send-email","name":"Send Email Notification","type":"n8n-nodes-base.gmail","position":[2260,340],"webhookId":"8fe18dee-cdd1-445f-8e8d-25c6794bc380","parameters":{"sendTo":"={{ $('Workflow Configuration').first().json.userEmail }}","message":"={{ $json.htmlEmail }}","options":{},"subject":"={{ $json.emailSubject }}"},"credentials":{"gmailOAuth2":{"id":"credential-id","name":"gmailOAuth2 Credential"}},"typeVersion":2.1},{"id":"log-history","name":"Log to Google Sheets","type":"n8n-nodes-base.googleSheets","position":[2480,340],"parameters":{"columns":{"value":{"date":"={{ $now.format('yyyy-MM-dd HH:mm') }}","author":"={{ $('Extract Book Details').first().json.bookAuthors }}","ai_comment":"={{ $('Book Curator AI Agent').first().json.review_summary }}","book_title":"={{ $('Extract Book Details').first().json.bookTitle }}","user_email":"={{ $('Workflow Configuration').first().json.userEmail }}"},"mappingMode":"defineBelow"},"options":{},"operation":"appendOrUpdate","sheetName":{"__rl":true,"mode":"name","value":"History"},"documentId":{"__rl":true,"mode":"id","value":"={{ $('Workflow Configuration').first().json.sheetId }}"}},"credentials":{"googleSheetsOAuth2Api":{"id":"credential-id","name":"googleSheetsOAuth2Api Credential"}},"typeVersion":4.7},{"id":"send-error","name":"Send Not Found Email","type":"n8n-nodes-base.gmail","position":[920,560],"webhookId":"f2fa6c4a-77e2-4174-9d90-8f3d1c7ceafa","parameters":{"sendTo":"={{ $('Workflow Configuration').first().json.userEmail }}","message":"=ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\nå…¥åŠ›ã•ã‚ŒãŸæ›¸åã€Œ{{ $('Workflow Configuration').first().json.bookTitle }}ã€ã«è©²å½“ã™ã‚‹æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nä»¥ä¸‹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š\n- æ›¸åã®ã‚¹ãƒšãƒ«ãŒæ­£ã—ã„ã‹\n- æ­£å¼ãªæ›¸åã§æ¤œç´¢ã—ã¦ã„ã‚‹ã‹\n- è‘—è€…åã‚’è¿½åŠ ã—ã¦ã¿ã‚‹\n\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚","options":{},"subject":"ğŸ“š èª­æ›¸ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼: æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ","emailType":"text"},"credentials":{"gmailOAuth2":{"id":"credential-id","name":"gmailOAuth2 Credential"}},"typeVersion":2.1},{"id":"output-parser","name":"Structured Output Parser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","position":[1660,540],"parameters":{"jsonSchemaExample":"{\n  \"review_summary\": \"This book is a masterpiece of...\",\n  \"related_books\": [\n    {\n      \"title\": \"Related Book 1\",\n      \"author\": \"Author A\",\n      \"reason\": \"Similar themes of...\"\n    },\n    {\n      \"title\": \"Related Book 2\",\n      \"author\": \"Author B\",\n      \"reason\": \"Explores the concept of...\"\n    }\n  ]\n}"},"typeVersion":1.3}],"pinData":{},"connections":{"Book Input Form":{"main":[[{"node":"Workflow Configuration","type":"main","index":0}]]},"Build HTML Email":{"main":[[{"node":"Send Email Notification","type":"main","index":0}]]},"Prepare AI Input":{"main":[[{"node":"Book Curator AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Book Curator AI Agent","type":"ai_languageModel","index":0}]]},"Check if Book Found":{"main":[[{"node":"Extract Book Details","type":"main","index":0}],[{"node":"Send Not Found Email","type":"main","index":0}]]},"Extract Book Details":{"main":[[{"node":"Search Book Reviews on Google","type":"main","index":0}]]},"Book Curator AI Agent":{"main":[[{"node":"Build HTML Email","type":"main","index":0}]]},"Workflow Configuration":{"main":[[{"node":"Search Book on Google Books API","type":"main","index":0}]]},"Send Email Notification":{"main":[[{"node":"Log to Google Sheets","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Book Curator AI Agent","type":"ai_outputParser","index":0}]]},"Search Book Reviews on Google":{"main":[[{"node":"Prepare AI Input","type":"main","index":0}]]},"Search Book on Google Books API":{"main":[[{"node":"Check if Book Found","type":"main","index":0}]]}}}
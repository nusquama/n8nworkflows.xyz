Telegram Support Bot with OpenAI, Pinecone and Human Expert Escalation

https://n8nworkflows.xyz/workflows/telegram-support-bot-with-openai--pinecone-and-human-expert-escalation-11324


# Telegram Support Bot with OpenAI, Pinecone and Human Expert Escalation

### 1. Workflow Overview

This workflow, titled **"Smart AI Support Assistant for Telegram"**, implements an intelligent support assistant integrated with Telegram, OpenAI, and Pinecone vector search, designed to handle user questions in a Telegram group chat. It automatically detects questions, searches an indexed knowledge base for relevant answers, auto-responds when a good match is found, and escalates unanswered questions to a human expert. The expert's replies are then learned and added back into the knowledge base for future automation.

The workflow is logically divided into the following blocks:

- **1.1 Incoming Message Reception and Classification:** Capture Telegram messages; distinguish between user questions and expert replies.
- **1.2 Question Validation and Filtering:** Analyze user messages to confirm they are valid questions based on keywords and question marks.
- **1.3 Knowledge Base Search and Auto-Answer:** Query Pinecone vector database with embeddings generated by OpenAI to find matching answers; send cached answers automatically.
- **1.4 Expert Escalation and Ticket Creation:** If no good match exists, create a ticket and forward the question to the expert via Telegram private chat.
- **1.5 Expert Reply Processing and Learning Loop:** Capture expert replies, extract Q&A pairs, update Pinecone with new knowledge, and send expert answers back to the group.

---

### 2. Block-by-Block Analysis

#### 2.1 Incoming Message Reception and Classification

**Overview:**  
This block listens for new Telegram messages in a group chat, extracts the chat/group ID, and distinguishes whether the message is a new question or a reply from an expert.

**Nodes Involved:**  
- Telegram Trigger  
- Extract Group ID (Code)  
- PrepareReplyFlag_Code (Code)  
- QuestionOrReply_Switch (Switch)  
- IsExpert_Code (Code)  
- IsExpert_IF (If)  

**Node Details:**  

- **Telegram Trigger**  
  - Type: Telegram Trigger  
  - Role: Receives incoming Telegram messages in the configured group chat.  
  - Configuration: Listens to "message" updates, using a Telegram bot credential (must be a group admin).  
  - I/O: Output to Extract Group ID.  
  - Edge Cases: Telegram API failures, webhook misconfiguration, bot missing permissions.  

- **Extract Group ID (Code)**  
  - Type: Code  
  - Role: Extracts chat ID from incoming Telegram message JSON for routing.  
  - Key Expression: `message?.chat?.id || ""`  
  - Input: Telegram Trigger  
  - Output: PrepareReplyFlag_Code  
  - Edge Cases: Missing or malformed chat ID in incoming message.  

- **PrepareReplyFlag_Code (Code)**  
  - Type: Code  
  - Role: Detects if the message is a reply by checking for a reply_to_message field and extracts referenced question ID from message text.  
  - Key Expressions: Regex for extracting question ID e.g. `Q:XXX` in replied message text.  
  - Input: Extract Group ID  
  - Output: QuestionOrReply_Switch  
  - Edge Cases: Missing reply_to_message or malformed reply text.  

- **QuestionOrReply_Switch (Switch)**  
  - Type: Switch  
  - Role: Routes flow based on whether the message is a new question (`reply_flag == false`) or an expert reply (`reply_flag == true`).  
  - Input: PrepareReplyFlag_Code  
  - Output:  
    - "Question" → QuestionFilter_Code (next block)  
    - "ReplyExpert" → IsExpert_Code (next node)  
  - Edge Cases: Unexpected or missing reply_flag values.  

- **IsExpert_Code (Code)**  
  - Type: Code  
  - Role: Checks if the user ID of the message sender is in the configured list of expert IDs.  
  - Configuration: Static array of expert Telegram user IDs.  
  - Input: QuestionOrReply_Switch (ReplyExpert branch)  
  - Output: IsExpert_IF  
  - Edge Cases: User ID missing or unrecognized.  

- **IsExpert_IF (If)**  
  - Type: If  
  - Role: Continues only if the sender is an expert, leading to expert reply processing.  
  - Input: IsExpert_Code  
  - Output: AddUserID_Metadata_Reply  
  - Edge Cases: False negatives if expert ID list outdated.  

---

#### 2.2 Question Validation and Filtering

**Overview:**  
Validates that incoming messages classified as questions contain actual question content by keyword matching and question mark detection, and filters out invalid or malformed questions.

**Nodes Involved:**  
- QuestionFilter_Code (Code)  
- ValidQuestion_IF (If)  
- Reformulate_Message (Telegram)  
- Set Original Question (Set)  

**Node Details:**  

- **QuestionFilter_Code (Code)**  
  - Type: Code  
  - Role: Checks if the message text contains question-related keywords or a question mark, and counts words.  
  - Keywords: Russian question words like "как", "почему", "что делать", etc.  
  - Output fields: `keywordMatch` (boolean), `matchedByKeyword`, `matchedByQuestionMark`, `wordsCount`.  
  - Input: QuestionOrReply_Switch (Question branch)  
  - Output: ValidQuestion_IF  
  - Edge Cases: Messages in other languages or short messages may produce false negatives.  

- **ValidQuestion_IF (If)**  
  - Type: If  
  - Role: Determines if the message is a valid question (keywordMatch==true and wordsCount>=2).  
  - Input: QuestionFilter_Code  
  - Output:  
    - True: Set Original Question node  
    - False: Reformulate_Message node (bot asks user to clarify question)  
  - Edge Cases: Edge cases with borderline short questions or rhetorical statements.  

- **Reformulate_Message (Telegram)**  
  - Type: Telegram  
  - Role: Sends a message back to the user asking to reformulate their question with more detail.  
  - Configuration: Replies to original message, no attribution appended.  
  - Input: ValidQuestion_IF (False)  
  - Output: None (ends flow)  
  - Edge Cases: Telegram API errors or blocked messages.  

- **Set Original Question (Set)**  
  - Type: Set  
  - Role: Stores the original text of the question and message ID for downstream processing.  
  - Input: ValidQuestion_IF (True)  
  - Output: Search Answer In Pinecone node  
  - Edge Cases: Missing message text or IDs.  

---

#### 2.3 Knowledge Base Search and Auto-Answer

**Overview:**  
Searches the Pinecone vector store for existing answers to the user’s question using OpenAI embeddings. If a suitable cached answer is found, it is sent automatically without expert intervention.

**Nodes Involved:**  
- Search Answer In Pinecone (Pinecone Vector Store)  
- Filter Similar Answers (Code)  
- Restore Original Question (Set)  
- Get First Answered Document (Code)  
- Check If Answer Exists (If)  
- Edit Fields (Set)  
- Send Auto Answer (Telegram)  
- CheckCacheHit (Code)  
- CacheHitIF (If)  
- SendCachedAnswer (Telegram)  

**Node Details:**  

- **Search Answer In Pinecone**  
  - Type: Pinecone Vector Store (Load mode)  
  - Role: Searches Pinecone index with the original question text to find top 3 similar Q&A pairs.  
  - Credentials: Pinecone API (configured with index and namespace)  
  - Input: Set Original Question  
  - Output: Filter Similar Answers  
  - Edge Cases: Pinecone API errors, empty or low-quality results.  

- **Filter Similar Answers (Code)**  
  - Type: Code  
  - Role: Filters and annotates Pinecone results for relevance, presence of answers, and minimum score threshold (0.85).  
  - Adds debug info for troubleshooting.  
  - Input: Search Answer In Pinecone  
  - Output: Restore Original Question  
  - Edge Cases: No results or inconsistent metadata fields.  

- **Restore Original Question (Set)**  
  - Type: Set  
  - Role: Restores original question content and user info from previous Set node for further processing.  
  - Input: Filter Similar Answers  
  - Output: Get First Answered Document  
  - Edge Cases: Missing original question or user metadata.  

- **Get First Answered Document (Code)**  
  - Type: Code  
  - Role: Selects the best matching answer document meeting score threshold (0.90). Sets flags if an answer exists.  
  - Input: Restore Original Question  
  - Output: Check If Answer Exists  
  - Edge Cases: No answer found, returns fallback with empty answer and flag to send to expert.  

- **Check If Answer Exists (If)**  
  - Type: If  
  - Role: Checks flags `has_answer == true` and score >= 0.85 to decide if auto-answer should be sent.  
  - Input: Get First Answered Document  
  - Output:  
    - True: Edit Fields  
    - False: EditFields_AddUserID_Metadata (for escalation)  
  - Edge Cases: Threshold tuning can impact false positives/negatives.  

- **Edit Fields (Set)**  
  - Type: Set  
  - Role: Prepares fields for sending auto-answer message (answer text, chat ID, reply_to_message_id).  
  - Input: Check If Answer Exists (True)  
  - Output: Send Auto Answer  
  - Edge Cases: Missing chat ID or message IDs.  

- **Send Auto Answer (Telegram)**  
  - Type: Telegram  
  - Role: Sends auto answer back to Telegram group chat, replying to original question message.  
  - Input: Edit Fields  
  - Edge Cases: Telegram API failures, message rate limits.  

- **CheckCacheHit (Code)**  
  - Type: Code  
  - Role: Checks if Pinecone search returned any cached answer above a low threshold (score > 0.1) to mark cache hit and prepare cached text.  
  - Input: Pinecone Vector Store (insert mode) after new ticket creation  
  - Output: CacheHitIF  
  - Edge Cases: Low score matches may produce irrelevant cache hits.  

- **CacheHitIF (If)**  
  - Type: If  
  - Role: Routes flow to send cached answer immediately if cacheHit==true, else continue normal processing.  
  - Input: CheckCacheHit  
  - Output:  
    - True: SendCachedAnswer  
    - False: Pinecone_ParseResult_Code (send to expert)  
  - Edge Cases: Misclassification of cache hits.  

- **SendCachedAnswer (Telegram)**  
  - Type: Telegram  
  - Role: Sends cached answer message to group chat.  
  - Input: CacheHitIF (True)  
  - Edge Cases: Telegram API errors.  

---

#### 2.4 Expert Escalation and Ticket Creation

**Overview:**  
When no suitable cached answer is found, the question is packaged as a ticket and forwarded to the human expert in a private chat. The question is also stored in Pinecone for future reference.

**Nodes Involved:**  
- EditFields_AddUserID_Metadata (Set)  
- CreateTicket_Code (Code)  
- Pinecone Vector Store (Insert mode)  
- Pinecone_ParseResult_Code (Code)  
- SendToExpert_Message (Telegram)  

**Node Details:**  

- **EditFields_AddUserID_Metadata (Set)**  
  - Type: Set  
  - Role: Adds and formats metadata such as user ID, chat ID, username, question text, and original message IDs for ticket creation.  
  - Input: Check If Answer Exists (False)  
  - Output: CreateTicket_Code  
  - Edge Cases: Missing or inconsistent metadata.  

- **CreateTicket_Code (Code)**  
  - Type: Code  
  - Role: Builds ticket JSON object with question details, user info, timestamps, and status set to "sent_to_expert".  
  - Input: EditFields_AddUserID_Metadata  
  - Output: Pinecone Vector Store (Insert mode)  
  - Edge Cases: Data completeness, timestamp formatting errors.  

- **Pinecone Vector Store (Insert mode)**  
  - Type: Pinecone Vector Store  
  - Role: Inserts the new question ticket as a document into the Pinecone vector index to build knowledge base.  
  - Input: CreateTicket_Code  
  - Output: CheckCacheHit (to detect if cache hit occurs post insert)  
  - Edge Cases: Pinecone API errors, duplicate documents.  

- **Pinecone_ParseResult_Code (Code)**  
  - Type: Code  
  - Role: Parses Pinecone search results to extract question metadata for forwarding.  
  - Input: CacheHitIF (False branch)  
  - Output: SendToExpert_Message  
  - Edge Cases: Missing or incomplete metadata.  

- **SendToExpert_Message (Telegram)**  
  - Type: Telegram  
  - Role: Sends a formatted message containing the new question to the expert’s private Telegram chat with instructions on how to reply.  
  - Input: Pinecone_ParseResult_Code  
  - Output: None (ends this branch)  
  - Edge Cases: Telegram API failures, chat ID misconfiguration, expert unavailability.  

---

#### 2.5 Expert Reply Processing and Learning Loop

**Overview:**  
Processes expert replies in private chat, extracts the answer and question, updates the knowledge base, and sends the expert’s answer back to the group chat.

**Nodes Involved:**  
- AddUserID_Metadata_Reply (Set)  
- Extract_Original_Question (Code)  
- GetFirstResult (Code)  
- Set_QA_for_Pinecone (Set)  
- WrapForPinecone (Code)  
- Pinecone_Add_Answer (Pinecone Vector Store Insert)  
- ExpertReply_Message (Telegram)  
- Default Data Loader1 (Document Loader)  
- Recursive Character Text Splitter1 (Text Splitter)  
- Embeddings OpenAI1 (Embeddings)  

**Node Details:**  

- **AddUserID_Metadata_Reply (Set)**  
  - Type: Set  
  - Role: Augments expert reply message with user_id, reply message id, chat id, question message id, and username for downstream processing.  
  - Input: IsExpert_IF  
  - Output: Extract_Original_Question  
  - Edge Cases: Missing fields in reply messages.  

- **Extract_Original_Question (Code)**  
  - Type: Code  
  - Role: Extracts the original question text and question ID from the expert’s reply text and reply_to message; captures expert answer and username.  
  - Input: AddUserID_Metadata_Reply  
  - Output: GetFirstResult  
  - Edge Cases: Parsing errors if expert message format changes.  

- **GetFirstResult (Code)**  
  - Type: Code  
  - Role: Selects the first item from the input array for further processing.  
  - Input: Extract_Original_Question  
  - Output: ExpertReply_Message  
  - Edge Cases: Empty input array.  

- **ExpertReply_Message (Telegram)**  
  - Type: Telegram  
  - Role: Sends the expert’s answer back to the original group chat, replying to the original question message.  
  - Input: GetFirstResult  
  - Output: Set_QA_for_Pinecone  
  - Edge Cases: Telegram API failures.  

- **Set_QA_for_Pinecone (Set)**  
  - Type: Set  
  - Role: Sets fields for question, answer, user id, chat id, question message id, username to prepare for Pinecone insertion.  
  - Input: ExpertReply_Message  
  - Output: WrapForPinecone  
  - Edge Cases: Data completeness.  

- **WrapForPinecone (Code)**  
  - Type: Code  
  - Role: Wraps Q&A data into a document structure compatible with Pinecone, including `pageContent` for text search.  
  - Input: Set_QA_for_Pinecone  
  - Output: Pinecone_Add_Answer  
  - Edge Cases: Formatting issues.  

- **Pinecone_Add_Answer (Pinecone Vector Store Insert)**  
  - Type: Pinecone Vector Store (Insert mode)  
  - Role: Inserts the new Q&A pair into the Pinecone index to augment knowledge base.  
  - Input: WrapForPinecone  
  - Output: None (end)  
  - Edge Cases: Pinecone API errors, duplicate entries.  

- **Default Data Loader1** and **Recursive Character Text Splitter1** and **Embeddings OpenAI1**  
  - These nodes prepare and generate embeddings for the expert’s answer before insertion into Pinecone, ensuring consistency with indexing format.  
  - Input: WrapForPinecone (ai_document and ai_embedding connections)  
  - Output: Pinecone_Add_Answer  
  - Edge Cases: OpenAI API rate limits or errors, text splitting issues.

---

### 3. Summary Table

| Node Name                     | Node Type                                  | Functional Role                             | Input Node(s)                 | Output Node(s)                      | Sticky Note                                                  |
|-------------------------------|--------------------------------------------|---------------------------------------------|------------------------------|------------------------------------|--------------------------------------------------------------|
| Telegram Trigger              | Telegram Trigger                           | Receives Telegram messages                   |                              | Extract Group ID                   | "Incoming messages & routing: Detects questions or replies." |
| Extract Group ID              | Code                                       | Extracts chat ID                             | Telegram Trigger             | PrepareReplyFlag_Code              |                                                              |
| PrepareReplyFlag_Code         | Code                                       | Detects if message is a reply, extracts QID| Extract Group ID             | QuestionOrReply_Switch             |                                                              |
| QuestionOrReply_Switch        | Switch                                     | Routes question vs expert reply              | PrepareReplyFlag_Code        | QuestionFilter_Code, IsExpert_Code |                                                              |
| IsExpert_Code                | Code                                       | Checks if sender is expert                    | QuestionOrReply_Switch       | IsExpert_IF                      |                                                              |
| IsExpert_IF                  | If                                         | Continues only if expert                      | IsExpert_Code               | AddUserID_Metadata_Reply          |                                                              |
| AddUserID_Metadata_Reply     | Set                                        | Adds metadata for expert reply processing    | IsExpert_IF                 | Extract_Original_Question         |                                                              |
| Extract_Original_Question    | Code                                       | Extracts original question and expert answer | AddUserID_Metadata_Reply    | GetFirstResult                   |                                                              |
| GetFirstResult               | Code                                       | Selects first item                            | Extract_Original_Question   | ExpertReply_Message              |                                                              |
| ExpertReply_Message          | Telegram                                   | Sends expert answer back to group chat       | GetFirstResult              | Set_QA_for_Pinecone              | "Expert reply → learn & update"                              |
| Set_QA_for_Pinecone          | Set                                        | Prepares Q&A metadata for DB insertion       | ExpertReply_Message         | WrapForPinecone                 |                                                              |
| WrapForPinecone              | Code                                       | Wraps Q&A for Pinecone insertion              | Set_QA_for_Pinecone         | Pinecone_Add_Answer             |                                                              |
| Pinecone_Add_Answer          | Pinecone Vector Store (Insert)              | Inserts expert's Q&A into knowledge base      | WrapForPinecone             |                                |                                                              |
| Default Data Loader1         | Document Loader (LangChain)                 | Prepares expert answer document               | WrapForPinecone             | Recursive Character Text Splitter1 |                                                              |
| Recursive Character Text Splitter1 | Text Splitter (LangChain)              | Splits expert answer text for embedding       | Default Data Loader1        | Embeddings OpenAI1              |                                                              |
| Embeddings OpenAI1           | Embeddings (LangChain)                      | Generates embeddings for expert answer        | Recursive Character Text Splitter1 | Pinecone_Add_Answer         |                                                              |
| QuestionFilter_Code          | Code                                       | Checks if message text is a valid question    | QuestionOrReply_Switch      | ValidQuestion_IF                | "Incoming messages & routing"                                |
| ValidQuestion_IF             | If                                         | Filters valid questions                        | QuestionFilter_Code         | Set Original Question, Reformulate_Message |                                                              |
| Reformulate_Message          | Telegram                                   | Asks user to reformulate unclear questions    | ValidQuestion_IF (false)    |                                |                                                              |
| Set Original Question        | Set                                        | Stores original question text and ID          | ValidQuestion_IF (true)     | Search Answer In Pinecone       |                                                              |
| Search Answer In Pinecone    | Pinecone Vector Store (Load)                 | Searches knowledge base for similar questions | Set Original Question       | Filter Similar Answers          | "Search and auto-answer from knowledge base"                |
| Filter Similar Answers       | Code                                       | Filters and annotates Pinecone search results | Search Answer In Pinecone   | Restore Original Question       |                                                              |
| Restore Original Question    | Set                                        | Restores original question data                | Filter Similar Answers      | Get First Answered Document     |                                                              |
| Get First Answered Document  | Code                                       | Selects best answer based on score threshold  | Restore Original Question   | Check If Answer Exists          |                                                              |
| Check If Answer Exists       | If                                         | Checks if suitable answer exists               | Get First Answered Document | Edit Fields, EditFields_AddUserID_Metadata |                                                              |
| Edit Fields                 | Set                                        | Prepares fields for auto-answer message        | Check If Answer Exists (true) | Send Auto Answer              | "No answer found → send to expert"                          |
| Send Auto Answer            | Telegram                                   | Sends cached answer to group chat               | Edit Fields                |                                |                                                              |
| EditFields_AddUserID_Metadata| Set                                        | Prepares metadata for ticket creation           | Check If Answer Exists (false) | CreateTicket_Code             |                                                              |
| CreateTicket_Code            | Code                                       | Builds ticket object for escalation             | EditFields_AddUserID_Metadata | Pinecone Vector Store (insert) |                                                              |
| Pinecone Vector Store        | Pinecone Vector Store (Insert)                | Inserts new ticket in knowledge base             | CreateTicket_Code           | CheckCacheHit                  | "No answer found → send to expert"                          |
| CheckCacheHit               | Code                                       | Detects if cache hit occurred post ticket insert| Pinecone Vector Store       | CacheHitIF                    |                                                              |
| CacheHitIF                  | If                                         | Routes to send cached answer or forward to expert| CheckCacheHit              | SendCachedAnswer, Pinecone_ParseResult_Code |                                                              |
| SendCachedAnswer            | Telegram                                   | Sends cached answer to group chat                | CacheHitIF                 |                                |                                                              |
| Pinecone_ParseResult_Code   | Code                                       | Parses Pinecone search results for forwarding    | CacheHitIF (false)         | SendToExpert_Message          |                                                              |
| SendToExpert_Message        | Telegram                                   | Sends question to expert in private chat          | Pinecone_ParseResult_Code  |                              | "No answer found → send to expert"                          |

---

### 4. Reproducing the Workflow from Scratch

1. **Create Telegram Trigger node:**  
   - Type: Telegram Trigger  
   - Parameters: Listen to "message" updates  
   - Credentials: Telegram bot with admin rights in target group chat  
   - Position: Starting node  

2. **Add Extract Group ID (Code) node:**  
   - Purpose: Extract chat ID from incoming message JSON  
   - Code: `return [{ json: { ...items[0].json, group_id: items[0].json.message?.chat?.id || "" } }];`  
   - Connect Telegram Trigger → Extract Group ID  

3. **Add PrepareReplyFlag_Code (Code) node:**  
   - Purpose: Detect if message is a reply and extract referenced question ID  
   - Code:  
     ```js
     const replyText = $json.message.reply_to_message?.text || "";
     const match = replyText.match(/Q:([^\s]+)/);
     const questionId = match ? match[1] : null;
     return [{ json: { reply_flag: Boolean($json.message.reply_to_message), question_id_from_reply: questionId, ...$json } }];
     ```  
   - Connect Extract Group ID → PrepareReplyFlag_Code  

4. **Add QuestionOrReply_Switch node:**  
   - Type: Switch  
   - Parameters:  
     - Output "Question": `reply_flag == false`  
     - Output "ReplyExpert": `reply_flag == true`  
   - Connect PrepareReplyFlag_Code → QuestionOrReply_Switch  

5. **In ReplyExpert branch:**  
   a. Add IsExpert_Code (Code) node:  
      - Define expert user IDs array in code and check if sender is expert.  
      - Connect QuestionOrReply_Switch (ReplyExpert) → IsExpert_Code  
   b. Add IsExpert_IF (If) node:  
      - Condition: isExpert == true  
      - Connect IsExpert_Code → IsExpert_IF  
   c. Add AddUserID_Metadata_Reply (Set) node:  
      - Add user_id, reply_message_id, chat_id, question_message_id, username from message fields  
      - Connect IsExpert_IF (true) → AddUserID_Metadata_Reply  
   d. Add Extract_Original_Question (Code) node:  
      - Extract original question text and expert answer from reply message  
      - Connect AddUserID_Metadata_Reply → Extract_Original_Question  
   e. Add GetFirstResult (Code) node:  
      - Select first item from extracted data  
      - Connect Extract_Original_Question → GetFirstResult  
   f. Add ExpertReply_Message (Telegram) node:  
      - Sends expert answer back to original group chat, replying to question message ID  
      - Connect GetFirstResult → ExpertReply_Message  
   g. Add Set_QA_for_Pinecone (Set) node:  
      - Prepare Q&A fields for insertion  
      - Connect ExpertReply_Message → Set_QA_for_Pinecone  
   h. Add WrapForPinecone (Code) node:  
      - Wrap data into Pinecone document format  
      - Connect Set_QA_for_Pinecone → WrapForPinecone  
   i. Add Default Data Loader1 (Document Loader) node:  
      - Load document for LangChain processing  
      - Connect WrapForPinecone → Default Data Loader1 (ai_document)  
   j. Add Recursive Character Text Splitter1 node:  
      - Split text for embedding  
      - Connect Default Data Loader1 → Recursive Character Text Splitter1 (ai_textSplitter)  
   k. Add Embeddings OpenAI1 node:  
      - Generate OpenAI embeddings  
      - Connect Recursive Character Text Splitter1 → Embeddings OpenAI1 (ai_embedding)  
   l. Add Pinecone_Add_Answer (Pinecone Insert) node:  
      - Insert new Q&A document in Pinecone index  
      - Connect WrapForPinecone → Pinecone_Add_Answer (main)  
      - Connect Embeddings OpenAI1 → Pinecone_Add_Answer (ai_embedding)  

6. **In Question branch:**  
   a. Add QuestionFilter_Code (Code) node:  
      - Check question keywords and presence of question mark  
      - Connect QuestionOrReply_Switch (Question) → QuestionFilter_Code  
   b. Add ValidQuestion_IF (If) node:  
      - Condition: keywordMatch == true AND wordsCount >= 2  
      - Connect QuestionFilter_Code → ValidQuestion_IF  
   c. Add Reformulate_Message (Telegram) node:  
      - Ask user to reformulate question if invalid  
      - Connect ValidQuestion_IF (false) → Reformulate_Message  
   d. Add Set Original Question (Set) node:  
      - Store original question text and message ID  
      - Connect ValidQuestion_IF (true) → Set Original Question  
   e. Add Search Answer In Pinecone (Pinecone Load) node:  
      - Search Pinecone index for similar questions  
      - Connect Set Original Question → Search Answer In Pinecone  
   f. Add Filter Similar Answers (Code) node:  
      - Annotate Pinecone results with relevance and answer presence  
      - Connect Search Answer In Pinecone → Filter Similar Answers  
   g. Add Restore Original Question (Set) node:  
      - Prepare question data for scoring  
      - Connect Filter Similar Answers → Restore Original Question  
   h. Add Get First Answered Document (Code) node:  
      - Find best answer above threshold  
      - Connect Restore Original Question → Get First Answered Document  
   i. Add Check If Answer Exists (If) node:  
      - Check has_answer == true AND score >= 0.85  
      - Connect Get First Answered Document → Check If Answer Exists  
   j. For True branch (answer exists):  
      - Add Edit Fields (Set) node: prepare answer message fields  
      - Connect Check If Answer Exists (true) → Edit Fields  
      - Add Send Auto Answer (Telegram) node: send cached answer to group  
      - Connect Edit Fields → Send Auto Answer  
   k. For False branch (no answer):  
      - Add EditFields_AddUserID_Metadata (Set) node: prepare metadata for ticket  
      - Connect Check If Answer Exists (false) → EditFields_AddUserID_Metadata  
      - Add CreateTicket_Code (Code) node: build ticket object  
      - Connect EditFields_AddUserID_Metadata → CreateTicket_Code  
      - Add Pinecone Vector Store (Insert) node: insert ticket into Pinecone  
      - Connect CreateTicket_Code → Pinecone Vector Store (Insert)  
      - Add CheckCacheHit (Code) node: detect cache hit after insert  
      - Connect Pinecone Vector Store (Insert) → CheckCacheHit  
      - Add CacheHitIF (If) node: route if cache hit or forward to expert  
      - Connect CheckCacheHit → CacheHitIF  
      - Add SendCachedAnswer (Telegram) node: send cached answer if cache hit  
      - Connect CacheHitIF (true) → SendCachedAnswer  
      - Add Pinecone_ParseResult_Code (Code) node: parse result for forwarding  
      - Connect CacheHitIF (false) → Pinecone_ParseResult_Code  
      - Add SendToExpert_Message (Telegram) node: send question to expert private chat  
      - Connect Pinecone_ParseResult_Code → SendToExpert_Message  

7. **Credentials Setup:**  
   - Telegram API: For the bot used in group and expert private chat  
   - Pinecone API: With index name and environment configured  
   - OpenAI API: For embeddings generation  

8. **Testing Flow:**  
   - Send various messages into the Telegram group, verify question detection, auto-answers, escalation to expert, and expert reply learning.

---

### 5. General Notes & Resources

| Note Content                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Context or Link                                                                                                      |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| ## How it works: 1. Detect questions in Telegram group; 2. Search knowledge base in Pinecone; 3. Auto-reply if answer exists; 4. Escalate unanswered questions to expert; 5. Expert replies are learned and added back to Pinecone. Setup instructions include bot admin rights, API keys, Pinecone index configuration. Test flow by sending questions and expert replies.                                                                                                                                                           | Detailed in Sticky Note node at position [-9120,192].                                                               |
| ## Incoming messages & routing: Detects whether a Telegram message is a user question or an expert reply; only valid questions proceed.                                                                                                                                                                                                                                                                                                                                                                               | Sticky Note node at [-8192,368].                                                                                     |
| ## Search and auto-answer from knowledge base: For valid questions, searches Pinecone and sends automatic answer if a good match is found.                                                                                                                                                                                                                                                                                                                                                                           | Sticky Note node at [-6880,80].                                                                                       |
| ## No answer found → send to expert: Creates ticket and forwards question to expert's private chat with the same bot.                                                                                                                                                                                                                                                                                                                                                                                                   | Sticky Note node at [-4720,96].                                                                                       |
| ## Expert reply → learn & update: Captures expert reply, updates Pinecone index, sends expert answer back to group chat for future auto-answering.                                                                                                                                                                                                                                                                                                                                                                    | Sticky Note node at [-6816,832].                                                                                      |
| This workflow requires Pinecone index setup with API key, OpenAI API key for embeddings, and a Telegram bot configured as group admin and accessible to expert user.                                                                                                                                                                                                                                                                                                                                                   | Pinecone docs: https://www.pinecone.io/docs/ <br> OpenAI docs: https://platform.openai.com/docs/ <br> Telegram Bot API: https://core.telegram.org/bots/api |

---

This completes the comprehensive structured documentation of the **"Telegram Support Bot with OpenAI, Pinecone and Human Expert Escalation"** n8n workflow, enabling understanding, reproduction, modification, and troubleshooting.
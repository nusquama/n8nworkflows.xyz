{"meta":{"instanceId":"735886904af210643f438394a538e64374f0cb4ab13fd94d97005987482d652a"},"nodes":[{"id":"09d0e55f-9758-46fe-919f-d29866635f62","name":"Sticky Note - Section 1","type":"n8n-nodes-base.stickyNote","position":[240,384],"parameters":{"color":7,"width":672,"height":752,"content":"## 1. Webhook & Validation\n[Read more about the Webhook node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.webhook)\n\nFacebook sends events to this webhook when users interact with your Messenger bot. The workflow validates these events, filters only text messages, and blocks echo messages from the bot itself.\n\n**Key nodes:**\n- **Facebook Webhook**: Receives both GET (verification) and POST (messages)\n- **Confirm Webhook**: Returns verification challenge or acknowledgment\n- **Is message**: Filters only events with text content\n- **From user?**: Blocks bot echo by comparing sender with page ID"},"typeVersion":1},{"id":"1d856115-11a5-49a5-871d-9422a742b672","name":"Sticky Note - Section 2","type":"n8n-nodes-base.stickyNote","position":[928,384],"parameters":{"color":7,"width":992,"height":752,"content":"## 2. AI Processing & Memory\n[Read more about Google Gemini Chat Model](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.lmchatgooglegemini/)\n[Read more about Memory Buffer Window](https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.memorybufferwindow/)\n\nThe core AI processing happens here. User messages are processed with Google Gemini AI while maintaining conversation context through Simple Memory.\n\n**Key nodes:**\n- **Set Context**: Extracts user_id, page_id, message, and token\n- **Seen & Typing**: Sends activity indicators to Messenger\n- **Conversation Memory**: Maintains last 10 messages per user\n- **Process Merged Message**: AI Agent with customizable system prompt\n- **Gemini Flash**: Google's language model for fast responses\n\n**Customization:** Edit the system prompt in \"Process Merged Message\" to change bot personality, tone, and behavior."},"typeVersion":1},{"id":"393b3906-3fb4-4a53-8dfe-0ba7056311b7","name":"Sticky Note - Section 3","type":"n8n-nodes-base.stickyNote","position":[1936,384],"parameters":{"color":7,"width":848,"height":752,"content":"## 3. Format & Send Response\n[Read more about the HTTP Request node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.httprequest)\n\nAI responses are formatted for Facebook Messenger compatibility and sent back to users via the Graph API.\n\n**Key nodes:**\n- **Cut if reply more than 2000 characters**: Strips markdown, truncates long messages\n- **Send Text**: Sends formatted message via Facebook Graph API\n\n**Messenger limits:** Maximum 2000 characters per message. This workflow truncates at 1900 with safety buffer."},"typeVersion":1},{"id":"34ad6797-0ba9-4800-9e15-4523aa86779f","name":"Set Context","type":"n8n-nodes-base.set","position":[992,800],"parameters":{"options":{},"assignments":{"assignments":[{"id":"user-id","name":"user_id","type":"string","value":"={{ $json.body.entry[0].messaging[0].sender.id }}"},{"id":"page-id","name":"page_id","type":"string","value":"={{ $json.body.entry[0].messaging[0].recipient.id }}"},{"id":"message-text","name":"message","type":"string","value":"={{ $json.body.entry[0].messaging[0].message.text }}"},{"id":"timestamp","name":"timestamp","type":"number","value":"={{ $json.body.entry[0].time }}"},{"id":"8393b92e-a5b2-4cec-b718-975963a08143","name":"page_access_token","type":"string","value":"YOUR_PAGE_ACCESS_TOKEN_HERE (EEa...)"}]}},"typeVersion":3.4},{"id":"8476c084-0fb2-42a9-97a4-d436ad168f4c","name":"Conversation Memory","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[1760,976],"parameters":{"sessionKey":"={{ $('Set Context').item.json.user_id }} {{ $('Set Context').item.json.page_id }}","sessionIdType":"customKey","contextWindowLength":10},"typeVersion":1.3},{"id":"f2a1a53f-1ff2-4d8b-ab8b-dfc89c2d3e77","name":"Facebook Webhook","type":"n8n-nodes-base.webhook","position":[272,800],"webhookId":"b12c5f3e-a7d7-4f0e-bd18-7b40f7c5f0d3","parameters":{"path":"nguyenthieutoan-facebook-page-1234","options":{},"responseMode":"responseNode","multipleMethods":true},"typeVersion":2.1},{"id":"e31b61ba-cddc-4d38-866c-d3e1affaaebb","name":"Confirm Webhook","type":"n8n-nodes-base.respondToWebhook","position":[496,688],"parameters":{"options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"text/plain"}]}},"respondWith":"text","responseBody":"={{ $json.query[\"hub.challenge\"] }}"},"typeVersion":1.5},{"id":"a4340780-79d9-436a-99c6-ec183db134e0","name":"Send Text","type":"n8n-nodes-base.httpRequest","position":[2208,800],"parameters":{"url":"=https://graph.facebook.com/v24.0/{{ $('Set Context').first().json.page_id }}/messages","method":"POST","options":{},"jsonBody":"={\n  \"recipient\": {\n    \"id\": \"{{ $('Set Context').first().json.user_id }}\"\n  },\n  \"messaging_type\": \"RESPONSE\",\n  \"message\": {\n    \"text\": {{JSON.stringify($json.page_message)}},\n    \"metadata\": \"bot_rep\"\n  }\n}","sendBody":true,"sendQuery":true,"specifyBody":"json","queryParameters":{"parameters":[{"name":"access_token","value":"={{ $('Set Context').first().json.page_access_token}}"}]}},"typeVersion":4.3},{"id":"da879b0b-f3ee-41e8-ac70-b1eb4dddcbb0","name":"Is message","type":"n8n-nodes-base.if","position":[496,816],"parameters":{"options":{},"conditions":{"options":{"version":3,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"50b4865e-d2b2-4c44-8d7b-5da029d0e9c4","operator":{"type":"string","operation":"exists","singleValue":true},"leftValue":"={{ $json.body.entry[0].messaging[0].message.text }}","rightValue":""}]}},"typeVersion":2.3},{"id":"a58a6832-7628-4f52-b55c-4a07f01a8ed9","name":"Typing","type":"n8n-nodes-base.httpRequest","onError":"continueRegularOutput","position":[1408,800],"parameters":{"url":"=https://graph.facebook.com/v24.0/{{ $('Set Context').first().json.page_id }}/messages","method":"POST","options":{"timeout":1000},"jsonBody":"={\n  \"recipient\": {\n    \"id\": \"{{ $('Set Context').first().json.user_id }}\"\n  },\n  \"sender_action\": \"typing_on\"\n}\n","sendBody":true,"sendQuery":true,"specifyBody":"json","queryParameters":{"parameters":[{"name":"access_token","value":"={{ $('Set Context').first().json.page_access_token }}"}]}},"typeVersion":4.3},{"id":"c6317f03-64a7-4482-8c2f-6f2abda7244d","name":"From user?","type":"n8n-nodes-base.if","position":[720,816],"parameters":{"options":{},"conditions":{"options":{"version":3,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"50b4865e-d2b2-4c44-8d7b-5da029d0e9c4","operator":{"type":"string","operation":"equals"},"leftValue":"={{ $json.body.entry[0].id }}","rightValue":"={{ $json.body.entry[0].messaging[0].recipient.id }}"}]}},"typeVersion":2.3},{"id":"68ef9536-4eeb-4499-9a3e-ce4076495777","name":"Gemini Flash","type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","position":[1600,976],"parameters":{"options":{}},"credentials":{"googlePalmApi":{"id":"ghryQ2MjpL9RracO","name":"jayracroi@gmail.com Paid 1"}},"typeVersion":1},{"id":"9cead490-7919-4191-8e57-62812abb7297","name":"Process Merged Message","type":"@n8n/n8n-nodes-langchain.agent","position":[1632,800],"parameters":{"text":"={{ $('Set Context').item.json.message }}","options":{"systemMessage":"=## Persona\nYou are Jenix, the personal AI assistant for Nguyễn Thiệu Toàn (Jay Nguyen) and his GenStaff Company. Your role is to act as a customer care consultant, supporting clients with information and guidance on AI & Automation services.\n\n## Core Directives\n1. Customer Care: Listen to customer needs, answer questions clearly, and provide helpful guidance.  \n2. Consult on Services: Explain how Nguyễn Thiệu Toàn's services support clients:  \n   - Automation workflows (n8n, AI tools)  \n   - AI-powered customer service chatbots (Facebook Messenger, Google Gemini, GPT models)  \n   - AI & Automation training for individuals and companies  \n3. Facilitate Scheduling: If interest is strong or questions are complex, offer to schedule a consultation with Nguyễn Thiệu Toàn.  \n4. Follow-up: Encourage customers to stay connected and reassure them of ongoing support.  \n\n## Conversational Flow\n- First Message: Always introduce yourself, adapting to the user's input language.  \n  - If input is Vietnamese: \"Chào anh/chị, em là Jenix, trợ lý AI của anh Nguyễn Thiệu Toàn. Em có thể hỗ trợ anh/chị về dịch vụ chăm sóc khách hàng và giải pháp Tự động hóa & AI ạ.\"  \n  - If input is English: \"Hello, I'm Jenix, the AI assistant of Mr. Nguyễn Thiệu Toàn. I can support you with customer care and AI & Automation solutions.\"  \n- Next Messages: Skip intro, go straight to answering the query with clear, supportive responses.  \n\n## Rules\n- Be concise, no filler.  \n- Always respond in the same language as the user's input.  \n  - Vietnamese: xưng \"em\", gọi khách là \"anh/chị\".  \n  - English: polite, professional \"I/you\".  \n\n## Tone of Voice\n- Friendly & approachable  \n- Supportive & empathetic  \n- Efficient, respectful of time  \n- Clever & witty when appropriate  \n\n## Output\n- Short, clear, under 1800 characters  \n- Plain text only  \n\n## Context\n- Date/time: {{ $now }}  \n"},"promptType":"define"},"typeVersion":3.1},{"id":"cdf77064-a608-421f-963d-29edc2d77ff6","name":"Seen","type":"n8n-nodes-base.httpRequest","onError":"continueRegularOutput","position":[1200,800],"parameters":{"url":"=https://graph.facebook.com/v24.0/{{ $('Set Context').item.json.page_id }}/messages","method":"POST","options":{"timeout":1000},"jsonBody":"={\n  \"recipient\": {\n    \"id\": \"{{ $('Set Context').item.json.user_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n} ","sendBody":true,"sendQuery":true,"specifyBody":"json","queryParameters":{"parameters":[{"name":"access_token","value":"={{ $('Set Context').item.json.page_access_token }}"}]}},"typeVersion":4.3},{"id":"d71c3244-8c5d-43ae-8a67-a959b2a6b0e0","name":"Cut if reply more than 2000 characters","type":"n8n-nodes-base.code","position":[2016,800],"parameters":{"jsCode":"// Normalize AI response before sending to Messenger\nconst input_data = $input.first().json;\nconst ai_text = input_data.output || input_data.text || '';\nlet clean_text = ai_text.trim();\n\n// Limit message length (Messenger: 2000 characters)\nif (clean_text.length > 1900) {\n  clean_text = clean_text.slice(0, 1897) + '...';\n}\n\n// Remove unsupported markdown formatting\nclean_text = clean_text\n  .replace(/\\*\\*(.+?)\\*\\*/g, '$1')   // remove bold\n  .replace(/\\*(.+?)\\*/g, '$1')       // remove italic\n  .replace(/```[\\s\\S]*?```/g, block => block.replace(/```\\w*\\n?/g, '')) // remove code blocks\n  .replace(/`(.+?)`/g, '$1');        // remove inline code\n\n// Return final result\nreturn {\n  json: {\n    page_message: clean_text\n  }\n};\n"},"typeVersion":2},{"id":"056d8116-080d-4348-9971-82aad2555323","name":"Sticky Note - Main Overview","type":"n8n-nodes-base.stickyNote","position":[-400,128],"parameters":{"width":624,"height":1008,"content":"## Try It Out!\n### This n8n template demonstrates how to build a simple but functional AI-powered customer service chatbot for Facebook Messenger using Google Gemini with conversation memory.\n\nThis is a lightweight version perfect for getting started with AI chatbots. For production use with advanced features like smart batching and human takeover, check the upgrade workflows linked below.\n\n### How it works\n* Facebook Webhook receives incoming messages from Messenger and validates them\n* The workflow filters out non-message events and bot echo messages\n* Set Context node extracts essential data: user_id, page_id, message text\n* Seen & Typing indicators show users the bot is actively responding\n* Simple Memory maintains the last 10 messages per user for context\n* Google Gemini processes the message with full conversation history\n* AI response is formatted for Messenger (strips markdown, truncates if >2000 chars)\n* Final message is sent back to user via Facebook Graph API\n\n### How to use\n* The webhook trigger automatically activates when users message your Facebook Page\n* Customize the AI personality by editing the system prompt in \"Process Merged Message\" node\n* Replace `YOUR_PAGE_ACCESS_TOKEN_HERE` in Set Context with your actual Facebook Page Access Token\n* Deploy on a publicly accessible n8n instance for Facebook to reach your webhook\n\n### Requirements\n* n8n instance (self-hosted or cloud) with public URL\n* Facebook App with Messenger product enabled\n* Facebook Page Access Token\n* Google Gemini API key\n\n### Author & Support\nCreated by **Nguyễn Thiệu Toàn** (Jay Nguyen)\n- Website: [nguyenthieutoan.com](https://nguyenthieutoan.com)\n- Email: me@nguyenthieutoan.com\n- n8n Workflows: [n8n.io/creators/nguyenthieutoan](https://n8n.io/creators/nguyenthieutoan)\n\n### LICENCE\nThis template is shared free of charge. Copyright belongs to [Nguyễn Thiệu Toàn](https://nguyenthieutoan.com) (n8n creator at n8n.io). Any copying or modification must credit the author."},"typeVersion":1},{"id":"ab7be654-afd9-46d7-8982-ac6448689813","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[928,960],"parameters":{"color":3,"width":320,"height":208,"content":"## ⚠️ Important!\n\nReplace `YOUR_PAGE_ACCESS_TOKEN_HERE` in the **Set Context node** with your actual Facebook Page Access Token.\n\nGet your token at:\n[developers.facebook.com](https://developers.facebook.com)"},"typeVersion":1},{"id":"19e6d753-7532-4a65-9eec-6c5f53730763","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[2800,384],"parameters":{"color":3,"width":336,"height":752,"content":"## Limitations & When to Upgrade\n\n⚠️ **This is a simple version** with basic features:\n\n**Current limitations:**\n- No smart batching (responds to each message immediately)\n- No human takeover detection (bot continues even when admin replies)\n- Basic memory (last 10 messages only, not production-ready)\n- Basic formatting (strips all markdown, brutal truncation)\n\n**Consider upgrading when you need:**\n- Production deployment with reliable data persistence\n- Analytics and conversation history tracking\n- Professional formatting with bold, italic, code blocks\n- Smart message batching (waits for user to finish typing)\n- Human handoff capability (bot pauses when admin joins)\n- Long message support (>2000 characters with smart splitting)\n\n**Upgrade workflows:**\n- **[Smart message batching workflow](https://n8n.io/workflows/9192)**: Prevents spam by waiting for user to finish\n- **[Smart human takeover workflow](https://n8n.io/workflows/11920)**: Auto-pauses bot when admin intervenes"},"typeVersion":1},{"id":"36bf4d1f-8826-4efb-803b-4073453ef959","name":"Switch","type":"n8n-nodes-base.switch","position":[2400,800],"parameters":{"rules":{"values":[{"outputKey":"Image exist?","conditions":{"options":{"version":3,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"83305cab-93f2-418d-8a1d-2cf158844c14","operator":{"type":"string","operation":"contains"},"leftValue":"={{ $('Process Merged Message').item.json.output.photo }}","rightValue":"http"}]},"renameOutput":true},{"outputKey":"Video exist?","conditions":{"options":{"version":3,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"156dbd55-5bbb-4974-bc42-01b97031851d","operator":{"type":"string","operation":"contains"},"leftValue":"={{ $('Process Merged Message').item.json.output.video }}","rightValue":"http"}]},"renameOutput":true}]},"options":{}},"typeVersion":3.4},{"id":"83590d96-f06d-4cd5-a395-e1f9158f12f0","name":"Send image","type":"n8n-nodes-base.httpRequest","position":[2656,736],"parameters":{"url":"=https://graph.facebook.com/v24.0/{{ $('Set Context').first().json.page_id }}/messages","method":"POST","options":{},"jsonBody":"={\n  \"recipient\": {\n    \"id\": \"{{ $('Set Context').first().json.user_id }}\"\n  },\n  \"messaging_type\": \"RESPONSE\",\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"image\",\n      \"payload\": {\n        \"url\": \"{{ $('Process Merged Message').item.json.output.photo }}\",\n        \"is_reusable\": true\n      }\n    }\n  }\n}\n","sendBody":true,"sendQuery":true,"specifyBody":"json","queryParameters":{"parameters":[{"name":"access_token","value":"={{ $('Set Context').first().json.page_access_token}}"}]}},"typeVersion":4.3},{"id":"ee63e73b-adcb-4186-83fa-b3e97a54ca76","name":"Send video","type":"n8n-nodes-base.httpRequest","position":[2656,912],"parameters":{"url":"=https://graph.facebook.com/v24.0/{{ $('Set Context').first().json.page_id }}/messages","method":"POST","options":{},"jsonBody":"={\n  \"recipient\": {\n    \"id\": \"{{ $('Set Context').first().json.user_id }}\"\n  },\n  \"messaging_type\": \"RESPONSE\",\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"video\",\n      \"payload\": {\n        \"url\": \"{{ $('Process Merged Message').item.json.output.video }}\",\n        \"is_reusable\": true\n      }\n    }\n  }\n}\n","sendBody":true,"sendQuery":true,"specifyBody":"json","queryParameters":{"parameters":[{"name":"access_token","value":"={{ $('Set Context').first().json.page_access_token}}"}]}},"typeVersion":4.3}],"pinData":{},"connections":{"Seen":{"main":[[{"node":"Typing","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Send image","type":"main","index":0}],[{"node":"Send video","type":"main","index":0}]]},"Typing":{"main":[[{"node":"Process Merged Message","type":"main","index":0}]]},"Send Text":{"main":[[{"node":"Switch","type":"main","index":0}]]},"From user?":{"main":[[{"node":"Set Context","type":"main","index":0}]]},"Is message":{"main":[[{"node":"From user?","type":"main","index":0}]]},"Set Context":{"main":[[{"node":"Seen","type":"main","index":0}]]},"Gemini Flash":{"ai_languageModel":[[{"node":"Process Merged Message","type":"ai_languageModel","index":0}]]},"Facebook Webhook":{"main":[[{"node":"Confirm Webhook","type":"main","index":0}],[{"node":"Confirm Webhook","type":"main","index":0},{"node":"Is message","type":"main","index":0}]]},"Conversation Memory":{"ai_memory":[[{"node":"Process Merged Message","type":"ai_memory","index":0}]]},"Process Merged Message":{"main":[[{"node":"Cut if reply more than 2000 characters","type":"main","index":0}]]},"Cut if reply more than 2000 characters":{"main":[[{"node":"Send Text","type":"main","index":0}]]}}}